{% extends "base.html" %}

{% block title %}Order Form{% endblock %}

{% block extra_scripts %}
    <script>
        function addDish() {
            const dishSelect = document.getElementById("dishSelect");
            const quantityInput = document.getElementById("quantityInput");
            const selectedDishes = document.getElementById("selectedDishes");

            const dishId = dishSelect.value;
            const dishName = dishSelect.options[dishSelect.selectedIndex].text;
            const quantity = parseInt(quantityInput.value);

            if (!dishId || quantity <= 0) {
                alert("Пожалуйста выберите блюдо и введите его корректное количество.");
                return;
            }

            const existingDish = document.getElementById(`dish-${dishId}`);
            if (existingDish) {
                const existingQuantityInput = existingDish.querySelector('input[name="quantities"]');
                const existingQuantityDisplay = existingDish.querySelector('.quantity-display');
                const existingQuantityNumberInput = existingDish.querySelector('.quantity-input');

                const existingQuantity = parseInt(existingQuantityInput.value);
                const newQuantity = existingQuantity + quantity;

                existingQuantityInput.value = newQuantity;
                existingQuantityDisplay.textContent = newQuantity;
                existingQuantityNumberInput.value = newQuantity;
            } else {
                const listItem = document.createElement("li");
                listItem.id = `dish-${dishId}`;
                listItem.innerHTML = `
                    ${dishName} - 
                    <span class="quantity-display">${quantity}</span> шт.
                    <input type="number" class="quantity-input" value="${quantity}" min="1" onchange="updateQuantity('${dishId}', this.value)">
                    <input type="hidden" name="dishes" value="${dishId}">
                    <input type="hidden" name="quantities" value="${quantity}">
                    <button type="button" onclick="removeDish('${dishId}')">Удалить</button>
                `;
                selectedDishes.appendChild(listItem);
            }
        }

        function updateQuantity(dishId, newQuantity) {
            const dishElement = document.getElementById(`dish-${dishId}`);
            if (dishElement) {
                const quantityDisplay = dishElement.querySelector('.quantity-display');
                const hiddenQuantityInput = dishElement.querySelector('input[name="quantities"]');

                quantityDisplay.textContent = newQuantity;
                hiddenQuantityInput.value = newQuantity;
            }
        }

        function removeDish(dishId) {
            const dishElement = document.getElementById(`dish-${dishId}`);
            if (dishElement) {
                dishElement.remove();
            }
        }

        // Function to pre-populate dishes when the page loads
        function populateDishes() {
            const selectedDishes = document.getElementById("selectedDishes");
            const dishes = [
                {% for orderdish in order.prefetched_dishes %}
                    {
                        id: "{{ orderdish.dish_id }}",
                        name: "{{ orderdish.dish_name }}",
                        quantity: {{ orderdish.quantity }}
                    },
                {% endfor %}
            ];

            dishes.forEach(dish => {
                const listItem = document.createElement("li");
                listItem.id = `dish-${dish.id}`;
                listItem.innerHTML = `
                    ${dish.name} - 
                    <span class="quantity-display">${dish.quantity}</span> шт.
                    <input type="number" class="quantity-input" value="${dish.quantity}" min="1" onchange="updateQuantity('${dish.id}', this.value)">
                    <input type="hidden" name="dishes" value="${dish.id}">
                    <input type="hidden" name="quantities" value="${dish.quantity}">
                    <button type="button" onclick="removeDish('${dish.id}')">Удалить</button>
                `;
                selectedDishes.appendChild(listItem);
            });
        }

        // Call populateDishes when the page loads
        window.onload = populateDishes;
    </script>
{% endblock %}

{% block content %}
    <h1>{% block heading %}Order Form{% endblock %}</h1>

    {% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        {% block table_number_input %}{% endblock %}
        <h3>Выберите блюда:</h3>
        <select id="dishSelect">
            {% for dish in dishes %}
                <option value="{{ dish.id }}">{{ dish.name }} - ${{ dish.price }}</option>
            {% endfor %}
        </select>
        <input type="number" id="quantityInput" placeholder="1" min="1" value="1">
        <button type="button" onclick="addDish()">Добавить к заказу</button>

        <h3>Выбранные блюда</h3>
        <ul id="selectedDishes">
        </ul>

        <button type="submit">{% block submit_button %}Оформить заказ{% endblock %}</button>
    </form>

    <a href="{% url 'order_list' %}">К списку заказов</a>
{% endblock %}